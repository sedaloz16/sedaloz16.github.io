
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Escáner de Plantas Medicinales</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; background: #f0f0f0; }
        video, canvas, img { border: 2px solid #333; margin-top: 10px; }
        #resultado { font-size: 1.2em; margin-top: 20px; }
        button, input[type=file] { padding: 10px 15px; margin: 10px; font-size: 1em; }
    </style>
</head>
<body>
    <h2>Escáner de Plantas Medicinales</h2>
    <video id="video" width="320" height="240" autoplay></video><br>
    <input type="file" id="imageUpload" accept="image/*"><br>
    <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
    <div>
        <button onclick="escanear()">Escanear con cámara</button>
        <button onclick="descargarPDF()">Descargar PDF</button>
    </div>
    <div id="resultado">Resultado: <b id="planta">---</b></div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const resultado = document.getElementById('planta');

        const baseDatos = {
            "Anís (Pimpinella anisum L.)": ["amarillo", "otro", "otro", "gris", "otro", "otro", "otro", "blanco", "verde", "verde", "otro", "gris", "verde", "verde", "otro", "blanco", "verde", "verde", "gris", "gris", "verde", "otro", "otro", "blanco", "gris", "gris", "otro", "gris", "otro", "otro", "otro", "blanco"],
            "Coca (Erythroxylum coca Lam.)": ["otro", "otro", "otro", "otro", "otro", "otro", "otro", "otro", "blanco", "blanco", "blanco", "blanco", "blanco", "blanco", "blanco", "blanco", "blanco", "blanco", "blanco", "blanco", "blanco", "blanco", "blanco", "blanco", "otro", "otro", "otro", "gris", "otro", "otro", "otro", "blanco"],
            "Diente de león (Taraxacum officinale F.H.Wigg.)": ["blanco", "blanco", "blanco", "blanco", "blanco", "blanco", "blanco", "blanco", "otro", "otro", "otro", "otro", "otro", "otro", "otro", "otro", "blanco", "blanco", "blanco", "blanco", "blanco", "blanco", "blanco", "blanco", "otro", "otro", "otro", "otro", "otro", "otro", "otro", "otro"],
            "Wira Wira (Achyrocline venosa Rusby)": ["gris", "otro", "otro", "gris", "otro", "verde", "otro", "blanco", "gris", "verde", "negro", "gris", "otro", "otro", "otro", "blanco", "otro", "otro", "otro", "blanco", "otro", "otro", "blanco", "blanco", "otro", "otro", "otro", "otro", "otro", "otro", "otro", "otro"]
        };

        // Iniciar cámara
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(stream => { video.srcObject = stream; })
            .catch(err => { console.error("Error al acceder a la cámara", err); });

        function escanear() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            detectarCodigo(canvas);
        }

        function clasificarColor(r, g, b) {
            if (r > 240 && g > 240 && b > 240) return "blanco";
            if (r < 30 && g < 30 && b < 30) return "negro";
            if (r > 200 && g > 200 && b < 100) return "amarillo";
            if (r > 200 && g < 80 && b < 80) return "rojo";
            if (g > 150 && r < 200 && b < 100) return "verde";
            if (Math.abs(r - g) < 20 && Math.abs(g - b) < 20 && r < 200) return "gris";
            return "otro";
        }

        function detectarCodigo(canvasEl) {
            const ctx = canvasEl.getContext('2d');
            const imageData = ctx.getImageData(250, 100, 64, 64); // Ajuste manual
            const colors = [];
            for (let i = 0; i < imageData.data.length; i += 4 * 16) {
                const r = imageData.data[i];
                const g = imageData.data[i+1];
                const b = imageData.data[i+2];
                colors.push(clasificarColor(r, g, b));
            }

            let match = "---";
            Object.entries(baseDatos).forEach(([planta, codigo]) => {
                if (codigo.slice(0, colors.length).every((c, i) => c === colors[i])) {
                    match = planta;
                }
            });

            resultado.textContent = match;
        }

        function descargarPDF() {
            const planta = resultado.textContent;
            const win = window.open("", "_blank");
            win.document.write(`<h1>Ficha de Planta</h1><p><strong>${planta}</strong></p><p>Datos adicionales se añadirán próximamente.</p>`);
            win.print();
        }

        // Carga de imagen manual
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const img = new Image();
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                detectarCodigo(canvas);
            };
            img.src = URL.createObjectURL(file);
        });
    </script>
</body>
</html>
